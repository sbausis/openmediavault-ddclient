#!/bin/sh
#
# Copyright (C) 2015 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

SERVICE="ddclient"
CONF_DIR="/etc/${SERVICE}"
DDCLIENT_CONF="/etc/${SERVICE}/${SERVICE}.conf"
CACHE_DIR="/var/cache/${SERVICE}"

if [ "$(omv_config_get "//services/ddclient/enable")" != "1" ]; then
    exit 0
fi

if [ ! -d "${CONF_DIR}" ]; then
        mkdir -p "${CONF_DIR}"
        chmod 755 "${CONF_DIR}"
fi

if [ ! -d "${CACHE_DIR}" ]; then
        mkdir -p "${CACHE_DIR}"
        chmod 755 "${CACHE_DIR}"
fi

#    "server"      : { "type" : "string"},
#    "username"    : { "type" : "string"},
#    "password"    : { "type" : "string"},
#    "hostname"    : { "type" : "string"},
#    "type"        : { "type" : "string"},
#    "ssl"         : { "type" : "boolean"},
#    "wildcard"    : { "type" : "boolean"},
#    "ipcheck"     : { "type" : "boolean"},
#    "interface"   : { "type" : "string"},
#    "seconds"     : { "type" : "integer", "minimum" : 300, "maximum" : 2592000 }

SERVER=$(omv_config_get "//services/ddclient/server")
case ${SERVER} in
	"members.dyndns.org") PROTOCOL="dyndns2" ;;
	"dynupdate.no-ip.com") PROTOCOL="dyndns2" ;;
	"freedns.afraid.org") PROTOCOL="freedns" ;;
	*) PROTOCOL="dyndns2" ;;
esac

USERNAME=$(omv_config_get "//services/ddclient/username")

PASSWORD=$(omv_config_get "//services/ddclient/password")

HOSTNAME=$(omv_config_get "//services/ddclient/hostname")

SSL=$(omv_config_get "//services/ddclient/ssl")
if [ "${SSL}" = "1" ]; then
	SSL="yes"
else
	SSL="no"
fi

WILDCARD=$(omv_config_get "//services/ddclient/wildcard")
if [ "${WILDCARD}" = "1" ]; then
	WILDCARD="yes"
else
	WILDCARD="no"
fi

SYSLOG=$(omv_config_get "//services/ddclient/syslog")
if [ "${SYSLOG}" = "1" ]; then
	SYSLOG="yes"
else
	SYSLOG="no"
fi

MAIL=$(omv_config_get "//services/ddclient/mail")
if [ "${MAIL}" = "1" ]; then
	MAIL="mail=root"
else
	MAIL=""
fi

MAILFAILURE=$(omv_config_get "//services/ddclient/mailfailure")
if [ "${MAILFAILURE}" = "1" ]; then
	MAILFAILURE="mail-failure=root"
else
	MAILFAILURE=""
fi

IPCHECK=$(omv_config_get "//services/ddclient/ipcheck")
if [ "${IPCHECK}" = "1" ]; then
	SOURCE="web, web=checkip.dyndns.com/, web-skip='IP Address'"
else
	INTERFACE=$(omv_config_get "//services/ddclient/interface")
	SOURCE="if, if=$INTERFACE"
fi

SECONDS=$(omv_config_get "//services/ddclient/seconds")

TYPE=$(omv_config_get "//services/ddclient/type")
case ${TYPE} in
	y) TYPE="static=yes, " ;;
	z) TYPE="custom=yes, " ;;
	x) TYPE="" ;;
	*) TYPE="" ;;
esac

cat <<EOF > ${DDCLIENT_CONF}
# Configuration file for ddclient generated by OpenMediaVault
#
# /etc/ddclient/ddclient.conf

pid=/var/run/ddclient.pid
timeout=10
daemon=$SECONDS
syslog=$SYSLOG
$MAIL
$MAILFAILURE
ssl=$SSL

use=$SOURCE
server=$SERVER
protocol=$PROTOCOL
login=$USERNAME
password=$PASSWORD
wildcard=$WILDCARD
$TYPE$HOSTNAME
EOF

chmod 600 ${DDCLIENT_CONF}
