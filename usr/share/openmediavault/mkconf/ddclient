#!/bin/sh
#
# Copyright (C) 2015 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

DDCLIENT_CONF="/etc/ddclient.conf"
DDCLIENT_DEFAULT="/etc/default/ddclient"

if [ "$(omv_config_get "//services/ddclient/enable")" != "1" ]; then
    exit 0
fi

    if [ `omv_config_get "//services/ddclient/ddns_type"` = "d" ]; then
        cat <<EOF > ${DDCLIENT_CONF}
# Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf

protocol=dyndns2
server=members.dyndns.org
login=$(omv_config_get "//services/ddclient/dusername")
password=$(omv_config_get "//services/ddclient/dpassword")
$(omv_config_get "//services/ddclient/dhostname")

ssl=$( if [ `omv_config_get "//services/ddclient/dssl"` = "1" ]; then echo "yes"; else echo "no"; fi)
wildcard=$( if [ `omv_config_get "//services/ddclient/dwildcard"` = "1" ]; then echo "yes"; else echo "no"; fi)
use=web, web=checkip.dyndns.com/, web-skip='IP Address'
EOF

    else
        cat <<EOF > ${DDCLIENT_CONF}
protocol=dyndns2
server=dynupdate.no-ip.com
login=$(omv_config_get "//services/ddclient/nusername")
password=$(omv_config_get "//services/ddclient/npassword")
$(omv_config_get "//services/ddclient/nhostname")
use=web, web=checkip.dyndns.com/, web-skip='IP Address'
EOF

    fi

   cat <<EOF > ${DDCLIENT_DEFAULT}
# Configuration for ddclient scripts 
# generated from debconf on Fri Apr 24 12:46:47 EDT 2015
#
# /etc/default/ddclient

# Set to "true" if ddclient should be run every time a new ppp connection is 
# established. This might be useful, if you are using dial-on-demand.
run_ipup="false"

# Set to "true" if ddclient should run in daemon mode
# If this is changed to true, run_ipup must be set to false.
run_daemon="true"

# Set the time interval between the updates of the dynamic DNS name in seconds.
# This option only takes effect if the ddclient runs in daemon mode.
daemon_interval="$(omv_config_get "//services/ddclient/seconds")"
EOF



